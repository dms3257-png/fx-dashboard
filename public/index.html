<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>FX Dashboard</title>

  <!-- ✅ PWA (minimal) -->
  <link rel="manifest" href="/manifest.webmanifest">
  <meta name="theme-color" content="#0b1020">

  <!-- Lightweight Charts 4.2.1 -->
  <script src="https://unpkg.com/lightweight-charts@4.2.1/dist/lightweight-charts.standalone.production.js"></script>

  <style>
    :root{
      --bg:#0b1020;
      --panel:#0f1733;
      --panel2:#0c132b;
      --text:#e7ecff;
      --muted:#96a3c7;
      --good:#35d07f;
      --warn:#ffcc00;
      --bad:#ff5577;
      --line:#2a3560;
      --chip:#18245a;
      --chipText:#cfe0ff;
      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      --sans: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, "Noto Sans KR", Arial, "Apple SD Gothic Neo", "Malgun Gothic", sans-serif;
    }
    html,body{height:100%}
    body{
      margin:0;
      background: radial-gradient(1200px 900px at 10% 0%, #111b3d 0%, var(--bg) 60%) fixed;
      color:var(--text);
      font-family:var(--sans);
    }
    a{color:#9cc2ff;text-decoration:none}
    a:hover{text-decoration:underline}

    .wrap{
      max-width:1200px;
      margin:0 auto;
      padding:18px 16px 30px;
    }
    .topbar{
      display:flex;
      gap:12px;
      align-items:flex-end;
      justify-content:space-between;
      padding:10px 12px;
      background:rgba(15,23,51,.55);
      border:1px solid rgba(150,163,199,.18);
      border-radius:14px;
      backdrop-filter: blur(8px);
    }
    .brand{
      display:flex;
      flex-direction:column;
      gap:4px;
    }
    .brand h1{
      margin:0;
      font-size:18px;
      letter-spacing:.2px;
    }
    .brand .sub{
      font-size:12px;
      color:var(--muted);
    }
    .statusRow{
      display:flex;
      gap:10px;
      align-items:center;
      flex-wrap:wrap;
      justify-content:flex-end;
    }
    .chip{
      display:inline-flex;
      align-items:center;
      gap:6px;
      padding:6px 10px;
      background:rgba(24,36,90,.55);
      border:1px solid rgba(150,163,199,.18);
      border-radius:999px;
      color:var(--chipText);
      font-size:12px;
      white-space:nowrap;
    }
    .dot{width:8px;height:8px;border-radius:50%}
    .dot.ok{background:var(--good)}
    .dot.warn{background:var(--warn)}
    .dot.bad{background:var(--bad)}
    .mono{font-family:var(--mono)}

    .grid{
      margin-top:14px;
      display:grid;
      grid-template-columns: 1.4fr .9fr;
      gap:14px;
    }
    @media (max-width: 980px){
      .grid{grid-template-columns:1fr}
    }

    .card{
      background:rgba(15,23,51,.65);
      border:1px solid rgba(150,163,199,.18);
      border-radius:14px;
      overflow:hidden;
    }
    .cardHeader{
      padding:12px 14px;
      display:flex;
      justify-content:space-between;
      align-items:center;
      border-bottom:1px solid rgba(150,163,199,.14);
      background:rgba(12,19,43,.65);
    }
    .cardHeader .title{
      font-size:13px;
      color:#dbe5ff;
      letter-spacing:.2px;
      display:flex;
      align-items:center;
      gap:8px;
      flex-wrap:wrap;
    }
    .cardHeader .meta{
      font-size:12px;
      color:var(--muted);
      white-space:nowrap;
    }
    .cardBody{padding:12px 14px}

    .kpis{
      display:grid;
      grid-template-columns: repeat(3, 1fr);
      gap:10px;
    }
    @media (max-width: 980px){
      .kpis{grid-template-columns: repeat(2, 1fr);}
    }
    .kpi{
      padding:10px 12px;
      background:rgba(12,19,43,.55);
      border:1px solid rgba(150,163,199,.14);
      border-radius:12px;
    }
    .kpi .label{font-size:12px;color:var(--muted)}
    .kpi .value{margin-top:6px;font-size:18px;font-weight:650;letter-spacing:.2px}
    .kpi .sub{margin-top:4px;font-size:11px;color:var(--muted)}
    .split{
      margin-top:10px;
      display:grid;
      grid-template-columns: 1fr;
      gap:14px;
    }

    .chart{
      height:310px;
    }
    .chart.small{height:260px}

    .panelText{
      font-size:13px;
      line-height:1.45;
      color:#d8e2ff;
    }
    .panelText .muted{color:var(--muted)}
    .panelText ul{margin:8px 0 0 18px}
    .panelText li{margin:4px 0}
    .hr{
      height:1px;
      background:rgba(150,163,199,.14);
      margin:10px 0;
    }
    .pill{
      display:inline-block;
      padding:2px 8px;
      border-radius:999px;
      border:1px solid rgba(150,163,199,.18);
      background:rgba(24,36,90,.35);
      color:#d2e0ff;
      font-size:11px;
      margin-left:6px;
      white-space:nowrap;
    }
    .warnBox{
      margin-top:10px;
      padding:10px 12px;
      border-radius:12px;
      border:1px solid rgba(255,204,0,.25);
      background:rgba(255,204,0,.08);
      color:#ffeaa7;
      font-size:12px;
    }
    .errBox{
      margin-top:10px;
      padding:10px 12px;
      border-radius:12px;
      border:1px solid rgba(255,85,119,.25);
      background:rgba(255,85,119,.08);
      color:#ffd0da;
      font-size:12px;
    }

    .foot{
      margin-top:16px;
      color:var(--muted);
      font-size:12px;
      text-align:center;
    }
    .foot code{font-family:var(--mono);font-size:12px}
  </style>
</head>

<body>
<div class="wrap">

  <div class="topbar">
    <div class="brand">
      <h1>FX Dashboard</h1>
      <div class="sub">
        KPI 10    60     SQLite
      </div>
    </div>
    <div class="statusRow">
      <span class="chip" id="chip_status"><span class="dot ok"></span><span class="mono">STATUS</span> <span id="status_text">-</span></span>
      <span class="chip"><span class="mono">asofKST</span> <span id="asof_text">-</span></span>
      <span class="chip"><span class="mono">API</span> <a href="/api/latest" target="_blank" rel="noopener">/api/latest</a></span>
    </div>
  </div>

  <div class="grid">
    <!-- LEFT -->
    <div class="card">
      <div class="cardHeader">
        <div class="title">
          USD/KRW <span class="pill">1m  24h</span>
        </div>
        <div class="meta">
          <a href="/api/candles?symbol=USDKRW&interval=1m&range=24h" target="_blank" rel="noopener">candles</a>
        </div>
      </div>
      <div class="cardBody">
        <div id="chart_usd" class="chart"></div>

        <div class="hr"></div>

        <div class="kpis">
          <div class="kpi">
            <div class="label">USD/KRW</div>
            <div class="value mono" id="k_usdkrw">-</div>
            <div class="sub muted"> </div>
          </div>
          <div class="kpi">
            <div class="label">EUR/KRW</div>
            <div class="value mono" id="k_eurkrw">-</div>
            <div class="sub muted"> </div>
          </div>
          <div class="kpi">
            <div class="label">DXY</div>
            <div class="value mono" id="k_dxy">-</div>
            <div class="sub muted">NAVER (DXY)</div>
          </div>
          <div class="kpi">
            <div class="label">KR10Y</div>
            <div class="value mono" id="k_kr10y">-</div>
            <div class="sub muted"> </div>
          </div>
          <div class="kpi">
            <div class="label">US10Y</div>
            <div class="value mono" id="k_us10y">-</div>
            <div class="sub muted"> </div>
          </div>
          <div class="kpi">
            <div class="label">Spread (USKR 10Y)</div>
            <div class="value mono" id="k_spread10y">-</div>
            <div class="sub muted">US10Y  KR10Y</div>
          </div>
        </div>

        <div class="split">
          <div class="card" style="background:transparent;border:none">
            <div class="cardHeader" style="border-radius:12px">
              <div class="title">
  외화보유액 <span class="pill">Line Auto-scale</span>
</div>
              <div class="meta"><a href="/api/candles?symbol=DXY&interval=30m&range=7d" target="_blank" rel="noopener">candles</a></div>
            </div>
            <div class="cardBody" style="padding:10px 0 0">
              <div id="chart_dxy" class="chart small"></div>
            </div>
          </div>

          <div class="card" style="background:transparent;border:none">
            <div class="cardHeader" style="border-radius:12px">
              <div class="title">
                KR10Y <span class="pill">line</span>
              </div>
              <div class="meta"><a href="/api/candles?symbol=KR10Y&interval=30m&range=30d" target="_blank" rel="noopener">candles</a></div>
            </div>
            <div class="cardBody" style="padding:10px 0 0">
              <div id="chart_kr10y" class="chart small"></div>
            </div>
          </div>
        </div>

      </div>
    </div>

    <!-- RIGHT -->
    <div class="card">
      <div class="cardHeader">
        <div class="title">
           (AI) <span class="pill">/api/analysis</span>
        </div>
        <div class="meta">
          <a href="/api/market/today" target="_blank" rel="noopener">market</a>
          <a href="/api/analysis?symbol=USDKRW" target="_blank" rel="noopener">analysis</a>
        </div>
      </div>
      <div class="cardBody">

        <div class="panelText" id="panel_report">
          <div class="muted">  (    /api/latest   )</div>
        </div>

        <div id="panel_warn" class="warnBox" style="display:none;"></div>
        <div id="panel_err" class="errBox" style="display:none;"></div>

        <div class="hr"></div>

        <div class="cardHeader" style="border-radius:12px; margin-bottom:10px;">
          <div class="title">
            () <span class="pill">Line  Auto-scale</span>
          </div>
          <div class="meta">
            <a href="/api/reserves" target="_blank" rel="noopener">/api/reserves</a>
          </div>
        </div>
        <div id="chart_reserves" class="chart small"></div>
        <div class="panelText muted" style="margin-top:8px">
          : USD bn  : BOK press release (public/data/reserves.json)
        </div>

      </div>
    </div>
  </div>

  <div class="foot">
    : <code>/api/latest</code>, <code>/api/candles</code>, <code>/api/reserves</code>
  </div>
</div>

<script>
  // ----------------------------
  // Utilities
  // ----------------------------
  const fmt = (v, d=2) => (v === null || v === undefined || Number.isNaN(v)) ? '-' : Number(v).toFixed(d);
  const fmtInt = (v) => (v === null || v === undefined || Number.isNaN(v)) ? '-' : Number(v).toLocaleString('en-US');
  const sleep = (ms) => new Promise(r => setTimeout(r, ms));

  async function fetchJSON(url){
    const r = await fetch(url, { cache: 'no-store' });
    if(!r.ok){
      const t = await r.text().catch(()=> '');
      const e = new Error(`HTTP ${r.status} ${r.statusText}`);
      e.status = r.status;
      e.body = t;
      throw e;
    }
    return r.json();
  }

  function toLCandles(arr){
    // expects: [{t,o,h,l,c}] where t is ms epoch
    // lightweight-charts: {time: seconds}
    return (arr || []).map(x => ({
      time: Math.floor(x.t / 1000),
      open: x.o, high: x.h, low: x.l, close: x.c
    }));
  }

  function toLLineFromCandles(arr){
    // line from close
    return (arr || []).map(x => ({ time: Math.floor(x.t / 1000), value: x.c }));
  }

  function toLLineMonthly(series){
    // expects: [{month:"YYYY-MM", value:Number}]
    // Use first day of month as UTC for time
    return (series || []).map(p => {
      const [y,m] = p.month.split('-').map(Number);
      const dt = new Date(Date.UTC(y, (m||1)-1, 1, 0, 0, 0));
      return { time: Math.floor(dt.getTime()/1000), value: Number(p.value) };
    });
  }

  function setStatusChip(status){
    const el = document.getElementById('chip_status');
    const dot = el.querySelector('.dot');
    const st = (status || '').toUpperCase();
    dot.classList.remove('ok','warn','bad');
    if(st === 'OK') dot.classList.add('ok');
    else if(st === 'WARN') dot.classList.add('warn');
    else dot.classList.add('bad');
    document.getElementById('status_text').textContent = st || '-';
  }

  // ----------------------------
  // Charts
  // ----------------------------
  const commonChartOptions = {
    layout: {
      background: { type: 'solid', color: 'rgba(0,0,0,0)' },
      textColor: '#d8e2ff',
      fontFamily: getComputedStyle(document.documentElement).getPropertyValue('--sans').trim()
    },
    grid: {
      vertLines: { color: 'rgba(150,163,199,.10)' },
      horzLines: { color: 'rgba(150,163,199,.10)' }
    },
    timeScale: {
      borderColor: 'rgba(150,163,199,.18)',
      timeVisible: true,
      secondsVisible: false,

      // ✅ X축 KST(Asia/Seoul)
      tickMarkFormatter: (time) => {
        const d = new Date(time * 1000);
        return d.toLocaleTimeString('ko-KR', {
          timeZone: 'Asia/Seoul',
          hour: '2-digit',
          minute: '2-digit',
          hour12: false,
        });
      },
    },

    rightPriceScale: { borderColor: 'rgba(150,163,199,.18)' },
    crosshair: {
      vertLine: { color: 'rgba(156,194,255,.25)' },
      horzLine: { color: 'rgba(156,194,255,.25)' }
    }
  };

  // USD chart (candles)
  const cUSD = LightweightCharts.createChart(document.getElementById('chart_usd'), {
    ...commonChartOptions,
    height: 310,
  });
  const sUSDCandle = cUSD.addCandlestickSeries({
    upColor: 'rgba(53,208,127,1)',
    downColor: 'rgba(255,85,119,1)',
    borderUpColor: 'rgba(53,208,127,1)',
    borderDownColor: 'rgba(255,85,119,1)',
    wickUpColor: 'rgba(53,208,127,1)',
    wickDownColor: 'rgba(255,85,119,1)',
  });

  // DXY (line)
  const cDXY = LightweightCharts.createChart(document.getElementById('chart_dxy'), {
    ...commonChartOptions,
    height: 260,
  });
  const sDXYLine = cDXY.addLineSeries({
    color: 'rgba(156,194,255,1)',
    lineWidth: 2,
  });

  // KR10Y (line)
  const cKR10Y = LightweightCharts.createChart(document.getElementById('chart_kr10y'), {
    ...commonChartOptions,
    height: 260,
  });
  const sKR10YLine = cKR10Y.addLineSeries({
    color: 'rgba(255,204,0,1)',
    lineWidth: 2,
  });

  // Reserves (line, auto-scale)
  const cRSV = LightweightCharts.createChart(document.getElementById('chart_reserves'), {
    ...commonChartOptions,
    height: 260,
  });
  const sRSVLine = cRSV.addLineSeries({
    color: 'rgba(53,208,127,1)',
    lineWidth: 2,
  });

  // Resize handler
  function resizeCharts(){
    const usdEl = document.getElementById('chart_usd');
    cUSD.applyOptions({ width: usdEl.clientWidth });
    const dxyEl = document.getElementById('chart_dxy');
    cDXY.applyOptions({ width: dxyEl.clientWidth });
    const krEl = document.getElementById('chart_kr10y');
    cKR10Y.applyOptions({ width: krEl.clientWidth });
    const rsvEl = document.getElementById('chart_reserves');
    cRSV.applyOptions({ width: rsvEl.clientWidth });
  }
  window.addEventListener('resize', resizeCharts);

  // ----------------------------
  // Data loaders
  // ----------------------------
  async function loadLatest(){
    const state = await fetchJSON('/api/latest');

    setStatusChip(state.status);
    document.getElementById('asof_text').textContent = state.asofKST || '-';

    // KPIs
    document.getElementById('k_usdkrw').textContent = fmtInt(state.usdkrw);
    document.getElementById('k_eurkrw').textContent = fmtInt(state.eurkrw);
    document.getElementById('k_dxy').textContent = fmt(state.dxy, 2);
    document.getElementById('k_kr10y').textContent = fmt(state.kr10y, 3) + '%';
    document.getElementById('k_us10y').textContent = fmt(state.us10y, 3) + '%';
    document.getElementById('k_spread10y').textContent = fmt(state.spread10y, 3) + ' pp';

    // errors panel
    const errs = Array.isArray(state.errors) ? state.errors : [];
    const warnEl = document.getElementById('panel_warn');
    const errEl  = document.getElementById('panel_err');
    warnEl.style.display = 'none';
    errEl.style.display  = 'none';

    if(state.status === 'WARN'){
      warnEl.style.display = 'block';
      warnEl.textContent = `WARN:      (: DXY). errors=${errs.length}`;
    }
    if(state.status && state.status !== 'OK' && state.status !== 'WARN'){
      errEl.style.display = 'block';
      errEl.textContent = `ERROR:  . errors=${errs.length}`;
    }

    return state;
  }

  async function loadCharts(){
    // 1) USD/KRW: 1m + 24h (candles)
    const usd = await fetchJSON('/api/candles?symbol=USDKRW&interval=1m&range=24h');
    sUSDCandle.setData(toLCandles(usd));
    cUSD.timeScale().fitContent();

    // 2) DXY: keep 30m + 7d (line)
    const dxy = await fetchJSON('/api/candles?symbol=DXY&interval=30m&range=7d');
    sDXYLine.setData(toLLineFromCandles(dxy));
    cDXY.timeScale().fitContent();

    // 3) KR10Y: keep 30m + 30d (line)
    const kr = await fetchJSON('/api/candles?symbol=KR10Y&interval=30m&range=30d');
    sKR10YLine.setData(toLLineFromCandles(kr));
    cKR10Y.timeScale().fitContent();
  }

  async function loadReserves(){
    // Monthly reserves (line + auto-scale via fitContent)
    const j = await fetchJSON('/api/reserves');
    const pts = toLLineMonthly(j.series || []);
    sRSVLine.setData(pts);
    cRSV.timeScale().fitContent();
  }

  async function loadReportFallback(state){
    // fallback text: use /api/latest only
    const el = document.getElementById('panel_report');
    const lines = [];
    lines.push(`<div><b>Action Brief</b> <span class="pill">fallback</span></div>`);
    lines.push(`<div class="muted" style="margin-top:6px">AI endpoint not available.</div>`);
    lines.push(`<ul>`);
    lines.push(`<li>USD/KRW: <span class="mono">${fmtInt(state.usdkrw)}</span></li>`);
    lines.push(`<li>EUR/KRW: <span class="mono">${fmtInt(state.eurkrw)}</span></li>`);
    lines.push(`<li>DXY: <span class="mono">${fmt(state.dxy,2)}</span></li>`);
    lines.push(`<li>10Y: KR <span class="mono">${fmt(state.kr10y,3)}%</span> / US <span class="mono">${fmt(state.us10y,3)}%</span> (Spread <span class="mono">${fmt(state.spread10y,3)} pp</span>)</li>`);
    lines.push(`</ul>`);
    el.innerHTML = lines.join('');
  }

  async function loadReport(){
    // Try /api/market/today + /api/analysis; if not present, fallback.
    const el = document.getElementById('panel_report');

    let state = null;
    try{
      state = await loadLatest();
    }catch(e){
      // if /api/latest fails, show raw error
      el.innerHTML = `<div class="muted">/api/latest failed: ${String(e.message || e)}</div>`;
      return;
    }

    // Try market today (optional)
    let market = null;
    try{
      market = await fetchJSON('/api/market/today');
    }catch(e){
      // ignore (endpoint may not exist yet)
    }

    // Try analysis (optional)
    let analysis = null;
    try{
      analysis = await fetchJSON('/api/analysis?symbol=USDKRW');
    }catch(e){
      // ignore (endpoint may not exist yet)
    }

    // If neither exists, fallback summary
    if(!market && !analysis){
      await loadReportFallback(state);
      return;
    }

    const html = [];
    html.push(`<div><b>Market Brief</b> <span class="pill">${analysis ? 'LLM' : 'no-LLM'}</span></div>`);
    html.push(`<div class="muted" style="margin-top:6px">KPI from /api/latest, news from /api/market/today, AI from /api/analysis.</div>`);

    // AI analysis block
    if(analysis){
      const text =
        analysis.text || analysis.summary || analysis.result || analysis.message || analysis.analysis || '';
      if(text){
        html.push(`<div class="hr"></div>`);
        html.push(`<div class="panelText" style="white-space:pre-wrap">${escapeHtml(String(text))}</div>`);
      }
    }

    // Market block (news/headlines)
    if(market){
      const headlines = market.headlines || market.news || market.mainnews || market.items || [];
      if(Array.isArray(headlines) && headlines.length){
        html.push(`<div class="hr"></div>`);
        html.push(`<div><b>Major News</b> <span class="pill">NAVER</span></div>`);
        html.push(`<ul>`);
        for(const it of headlines.slice(0, 6)){
          if(typeof it === 'string'){
            html.push(`<li>${escapeHtml(it)}</li>`);
          }else{
            const title = it.title || it.text || it.headline || '(no title)';
            const url = it.url || it.link || '';
            if(url) html.push(`<li><a href="${url}" target="_blank" rel="noopener">${escapeHtml(title)}</a></li>`);
            else html.push(`<li>${escapeHtml(title)}</li>`);
          }
        }
        html.push(`</ul>`);
      }else{
        html.push(`<div class="hr"></div>`);
        html.push(`<div class="muted">market/today is present but no headlines.</div>`);
      }
    }

    // Always include KPI snapshot
    html.push(`<div class="hr"></div>`);
    html.push(`<div><b>KPI Snapshot</b> <span class="pill">${escapeHtml(state.asofKST || '-')}</span></div>`);
    html.push(`<ul>`);
    html.push(`<li>USD/KRW: <span class="mono">${fmtInt(state.usdkrw)}</span></li>`);
    html.push(`<li>EUR/KRW: <span class="mono">${fmtInt(state.eurkrw)}</span></li>`);
    html.push(`<li>DXY: <span class="mono">${fmt(state.dxy,2)}</span></li>`);
    html.push(`<li>10Y Spread: <span class="mono">${fmt(state.spread10y,3)} pp</span></li>`);
    html.push(`</ul>`);

    el.innerHTML = html.join('');
  }

  function escapeHtml(s){
    return s
      .replaceAll('&','&amp;')
      .replaceAll('<','&lt;')
      .replaceAll('>','&gt;')
      .replaceAll('"','&quot;')
      .replaceAll("'","&#039;");
  }

  // ----------------------------
  // Scheduling / boot
  // ----------------------------
  async function fullReload(){
    try{ await loadLatest(); } catch(e){}
    try{ await loadCharts(); } catch(e){}
    try{ await loadReserves(); } catch(e){}
    try{ await loadReport(); } catch(e){}
    resizeCharts();
  }

  // Initial load
  fullReload();

  // KPI: every 10s
  setInterval(() => loadLatest().catch(()=>{}), 10_000);

  // Charts: every 60s (USD 1m chart + others)
  setInterval(() => loadCharts().catch(()=>{}), 60_000);

  // Reserves: every 10min (monthly; not necessary to be frequent)
  setInterval(() => loadReserves().catch(()=>{}), 600_000);

  // Report: every 2 hours
  setInterval(() => loadReport().catch(()=>{}), 2 * 60 * 60 * 1000);
</script>

<!-- ✅ PWA (minimal) : register service worker -->
<script>
  if ('serviceWorker' in navigator) {
    window.addEventListener('load', () => {
      navigator.serviceWorker.register('/sw.js').catch(console.warn);
    });
  }
</script>

</body>
</html>

